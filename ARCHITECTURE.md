# Invoice System - 시스템 아키텍처

## 시스템 개요도

```
┌─────────────────────────────────────────────────────────────────┐
│                         Client Layer                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   Browser    │  │  Mobile App  │  │  API Client  │          │
│  │   (UI/UX)    │  │   (Future)   │  │  (External)  │          │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘          │
│         │                 │                 │                    │
└─────────┼─────────────────┼─────────────────┼────────────────────┘
          │                 │                 │
          └─────────────────┼─────────────────┘
                            │ HTTP/HTTPS
                            │
┌───────────────────────────┼─────────────────────────────────────┐
│                    Django Application Layer                      │
│                            │                                     │
│  ┌─────────────────────────┴──────────────────────────────┐    │
│  │              Django URL Router                          │    │
│  └─────┬──────────────────────────┬───────────────────────┘    │
│        │                          │                             │
│   ┌────┴──────┐            ┌──────┴─────────┐                  │
│   │ Core App  │            │   API App      │                  │
│   │ (Web UI)  │            │  (REST API)    │                  │
│   └────┬──────┘            └──────┬─────────┘                  │
│        │                          │                             │
│   ┌────┴────────────────────┬─────┴─────────┐                  │
│   │                         │               │                  │
│   │  Views (Web)           │   Views (API) │                  │
│   │  - Login               │   - Process   │                  │
│   │  - Dashboard           │   - Logs      │                  │
│   │  - Service Mgmt        │   - Config    │                  │
│   │  - Declaration         │               │                  │
│   │                         │               │                  │
│   └────┬────────────────────┴───────────────┘                  │
│        │                                                        │
│   ┌────┴─────────────────────────────────────┐                 │
│   │         Services Layer                   │                 │
│   │  ┌──────────────┐  ┌─────────────────┐  │                 │
│   │  │ OCR Service  │  │ ChatGPT Service │  │                 │
│   │  │ (Vision API) │  │  (OpenAI API)   │  │                 │
│   │  └──────────────┘  └─────────────────┘  │                 │
│   │              InvoiceProcessor            │                 │
│   └────┬─────────────────────────────────────┘                 │
│        │                                                        │
│   ┌────┴─────────────────────────────────────┐                 │
│   │         Models (ORM Layer)               │                 │
│   │  - CustomUser    - Service               │                 │
│   │  - ServiceUser   - Declaration           │                 │
│   │  - MappingInfo   - PromptConfig          │                 │
│   │  - InvoiceProcessLog                     │                 │
│   └────┬─────────────────────────────────────┘                 │
└────────┼──────────────────────────────────────────────────────┘
         │ Django ORM
         │
┌────────┼──────────────────────────────────────────────────────┐
│        │           Data Layer                                  │
│   ┌────┴─────────────────┐  ┌─────────────────────┐           │
│   │  MSSQL Database      │  │  File Storage       │           │
│   │  - Users             │  │  - Invoice Images   │           │
│   │  - Services          │  │  - Static Files     │           │
│   │  - Declarations      │  │  - Media Files      │           │
│   │  - Mappings          │  │                     │           │
│   │  - Prompts           │  │                     │           │
│   │  - Process Logs      │  │                     │           │
│   └──────────────────────┘  └─────────────────────┘           │
└───────────────────────────────────────────────────────────────┘
         │                           │
         │                           │
┌────────┼───────────────────────────┼────────────────────────────┐
│        │      External Services    │                            │
│   ┌────┴──────────────┐  ┌─────────┴──────────┐                │
│   │  Google Cloud     │  │   OpenAI API       │                │
│   │  Vision API       │  │   (GPT-4 Vision)   │                │
│   │  (OCR)            │  │   (AI Analysis)    │                │
│   └───────────────────┘  └────────────────────┘                │
└─────────────────────────────────────────────────────────────────┘
```

## 데이터 흐름도 (Invoice 처리)

```
┌────────────┐
│  Client    │
│  (Upload)  │
└─────┬──────┘
      │ 1. POST /api/process/
      │    (image, service_user_id, declaration_id)
      │
      ▼
┌─────────────────────────────────────────────┐
│          Django API View                    │
│  1. 인증 확인                               │
│  2. 권한 검증                               │
│  3. 이미지 저장                             │
│  4. InvoiceProcessLog 생성                  │
└─────┬───────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────────┐
│      InvoiceProcessor Service               │
│  ┌────────────────────────────────────┐    │
│  │  Step 2: OCR 텍스트 추출            │    │
│  │  - Google Vision API 호출           │    │
│  │  - 이미지 → 텍스트 변환             │    │
│  └────────┬───────────────────────────┘    │
│           │                                  │
│  ┌────────▼───────────────────────────┐    │
│  │  Step 3-4: ChatGPT 분석             │    │
│  │  - 이미지 + OCR 텍스트 전송         │    │
│  │  - 매핑정보 + 프롬프트 전달         │    │
│  │  - JSON 데이터 구조화               │    │
│  └────────┬───────────────────────────┘    │
│           │                                  │
│  ┌────────▼───────────────────────────┐    │
│  │  Step 5: 결과 정리                  │    │
│  │  - JSON 검증                        │    │
│  │  - 처리 시간 계산                   │    │
│  │  - 로그 업데이트                    │    │
│  └────────┬───────────────────────────┘    │
└───────────┼──────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────┐
│          Database Update                    │
│  - InvoiceProcessLog.status = 'completed'   │
│  - ocr_text, result_json 저장               │
│  - processing_time 기록                     │
└─────┬───────────────────────────────────────┘
      │
      ▼
┌────────────────────────────────────────────┐
│         API Response                        │
│  {                                         │
│    "success": true,                        │
│    "data": {...},                          │
│    "ocr_text": "...",                      │
│    "processing_time": 5.23,                │
│    "log_id": 123                           │
│  }                                         │
└────────────────────────────────────────────┘
```

## 사용자 권한 흐름도

```
┌─────────────┐
│   Login     │
└──────┬──────┘
       │
       ▼
    Is Admin?
       │
  ┌────┴────┐
  │         │
YES         NO
  │         │
  ▼         ▼
┌──────────────┐  ┌──────────────┐
│ Admin View   │  │ Customs View │
│              │  │              │
│ ✓ 서비스     │  │ ✓ 대시보드    │
│   리스트     │  │ ✓ 내 서비스   │
│ ✓ 모든 업체  │  │ ✓ 신고서     │
│   관리       │  │   관리       │
│ ✓ 기본       │  │ ✓ 추가       │
│   프롬프트   │  │   프롬프트   │
│   수정       │  │   수정       │
└──────────────┘  └──────────────┘
```

## 데이터베이스 ERD

```
┌─────────────────┐
│   CustomUser    │
├─────────────────┤
│ • id (PK)       │
│ • username      │
│ • password      │
│ • user_type     │◄───────┐
│ • customs_code  │        │
│ • customs_name  │        │
│ • is_first_login│        │
└────────┬────────┘        │
         │                 │
         │ 1:N             │
         │                 │
┌────────▼────────┐        │
│  ServiceUser    │        │
├─────────────────┤        │
│ • id (PK)       │        │
│ • service_id(FK)│───┐    │
│ • user_id (FK)  │   │    │
│ • is_default    │   │    │
└────────┬────────┘   │    │
         │            │    │
         │ 1:N        │    │
         │            │    │
┌────────▼────────┐   │    │
│  MappingInfo    │   │    │
├─────────────────┤   │    │
│ • id (PK)       │   │    │
│ • declaration(FK)│──┤    │
│ • service_user  │   │    │
│ • unipass_field │   │    │
│ • db_table_name │   │    │
│ • db_field_name │   │    │
└────────┬────────┘   │    │
         │            │    │
         │ 1:N        │    │
         │            │    │
┌────────▼────────┐   │    │
│ PromptConfig    │   │    │
├─────────────────┤   │    │
│ • id (PK)       │   │    │
│ • mapping_id(FK)│   │    │
│ • prompt_type   │   │    │
│ • prompt_text   │   │    │
│ • service_user  │   │    │
│ • created_by(FK)│───┘────┘
└─────────────────┘

┌─────────────────┐        ┌─────────────────┐
│    Service      │        │  Declaration    │
├─────────────────┤        ├─────────────────┤
│ • id (PK)       │◄───1:N─│ • id (PK)       │
│ • name          │        │ • service_id(FK)│
│ • description   │        │ • name          │
│ • is_active     │        │ • type          │
└─────────────────┘        └─────────────────┘

┌──────────────────────┐
│ InvoiceProcessLog    │
├──────────────────────┤
│ • id (PK)            │
│ • service_user_id(FK)│
│ • declaration_id (FK)│
│ • image_file         │
│ • ocr_text           │
│ • gpt_response       │
│ • result_json        │
│ • status             │
│ • processing_time    │
└──────────────────────┘
```

## 컴포넌트 다이어그램

```
┌────────────────────────────────────────────────────┐
│                 Frontend Layer                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐         │
│  │  Login   │  │Dashboard │  │ Service  │         │
│  │  Page    │  │   Page   │  │   Mgmt   │         │
│  └──────────┘  └──────────┘  └──────────┘         │
│                                                     │
│  ┌──────────────────────────────────────────┐     │
│  │        Toss Design System                │     │
│  │  - Colors, Typography, Components        │     │
│  └──────────────────────────────────────────┘     │
└────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────┐
│              Backend Layer (Django)                │
│  ┌──────────────────────────────────────────┐     │
│  │         Authentication Middleware         │     │
│  │  - Session Management                    │     │
│  │  - Permission Check                      │     │
│  └──────────────────────────────────────────┘     │
│                                                     │
│  ┌──────────────┐        ┌──────────────┐         │
│  │  Core Views  │        │  API Views   │         │
│  │  (Web UI)    │        │  (REST API)  │         │
│  └──────┬───────┘        └──────┬───────┘         │
│         │                       │                  │
│         └───────┬───────────────┘                  │
│                 │                                   │
│  ┌──────────────┴──────────────────────────┐      │
│  │         Business Logic Layer            │      │
│  │  ┌──────────────┐  ┌────────────────┐  │      │
│  │  │ OCRService   │  │ ChatGPTService │  │      │
│  │  └──────────────┘  └────────────────┘  │      │
│  │           InvoiceProcessor              │      │
│  └─────────────────────────────────────────┘      │
│                 │                                   │
│  ┌──────────────┴──────────────────────────┐      │
│  │            Django ORM Layer             │      │
│  │  - Models                               │      │
│  │  - QuerySets                            │      │
│  │  - Transactions                         │      │
│  └─────────────────────────────────────────┘      │
└────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────┐
│              External Services                     │
│  ┌──────────────┐        ┌──────────────┐         │
│  │ Google Cloud │        │   OpenAI     │         │
│  │ Vision API   │        │     API      │         │
│  └──────────────┘        └──────────────┘         │
└────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────┐
│                Data Layer                          │
│  ┌──────────────┐        ┌──────────────┐         │
│  │   MSSQL DB   │        │ File Storage │         │
│  └──────────────┘        └──────────────┘         │
└────────────────────────────────────────────────────┘
```

## 보안 레이어

```
┌───────────────────────────────────────────┐
│          Security Layers                  │
│                                            │
│  ┌──────────────────────────────────┐    │
│  │  1. Network Layer                │    │
│  │     - HTTPS/TLS                  │    │
│  │     - Firewall Rules             │    │
│  └──────────────────────────────────┘    │
│                                            │
│  ┌──────────────────────────────────┐    │
│  │  2. Application Layer            │    │
│  │     - CSRF Protection            │    │
│  │     - CORS Settings              │    │
│  │     - Session Management         │    │
│  └──────────────────────────────────┘    │
│                                            │
│  ┌──────────────────────────────────┐    │
│  │  3. Authentication Layer         │    │
│  │     - Password Hashing           │    │
│  │     - First Login Check          │    │
│  │     - Permission Verification    │    │
│  └──────────────────────────────────┘    │
│                                            │
│  ┌──────────────────────────────────┐    │
│  │  4. Data Layer                   │    │
│  │     - SQL Injection Prevention   │    │
│  │     - API Key Protection         │    │
│  │     - Sensitive Data Encryption  │    │
│  └──────────────────────────────────┘    │
└───────────────────────────────────────────┘
```

## 배포 아키텍처 (Production)

```
┌─────────────────────────────────────────────────────┐
│                   Internet                          │
└──────────────────┬──────────────────────────────────┘
                   │
┌──────────────────▼──────────────────────────────────┐
│                Load Balancer                        │
│              (Nginx / HAProxy)                      │
└──────────────────┬──────────────────────────────────┘
                   │
     ┌─────────────┼─────────────┐
     │             │             │
┌────▼────┐   ┌────▼────┐   ┌────▼────┐
│ Django  │   │ Django  │   │ Django  │
│ Server1 │   │ Server2 │   │ Server3 │
│(Gunicorn│   │(Gunicorn│   │(Gunicorn│
└────┬────┘   └────┬────┘   └────┬────┘
     │             │             │
     └─────────────┼─────────────┘
                   │
     ┌─────────────┼─────────────┐
     │             │             │
┌────▼────────┐  ┌▼──────────┐ ┌▼─────────┐
│   MSSQL     │  │   Redis   │ │   CDN    │
│  Database   │  │  (Cache)  │ │ (Static) │
│  (Master)   │  │           │ │          │
└─────────────┘  └───────────┘ └──────────┘
     │
┌────▼────────┐
│   MSSQL     │
│  Database   │
│  (Replica)  │
└─────────────┘
```

---

**문서 버전**: 1.0
**최종 수정**: 2024-01-15
