{% extends 'base.html' %}

{% block title %}{{ declaration.name }} ì„¤ì • - Invoice System{% endblock %}

{% block extra_css %}
<style>
    .breadcrumb {
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: var(--text-secondary);
        flex-wrap: wrap;
    }

    .breadcrumb a {
        color: var(--primary-blue);
        text-decoration: none;
    }

    .page-header {
        margin-bottom: 32px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .mapping-section {
        margin-bottom: 40px;
    }

    .section-title {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 20px;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .section-icon {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, var(--primary-blue), #667eea);
        color: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }

    .mapping-table-container {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: visible;
    }

    .mapping-table {
        width: auto;
        border-collapse: collapse;
    }

    .mapping-table thead {
        background: var(--bg-color);
    }

    .mapping-table th {
        padding: 12px;
        text-align: left;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        border-bottom: 2px solid var(--border-color);
        white-space: nowrap;
        position: sticky;
        top: 0;
        background: var(--bg-color);
        z-index: 10;
    }

    .mapping-table td {
        padding: 12px;
        border-bottom: 1px solid var(--border-color);
        font-size: 13px;
        vertical-align: top;
    }

    .mapping-table tbody tr:hover {
        background: var(--bg-color);
    }

    .mapping-table tbody tr:last-child td {
        border-bottom: none;
    }

    .field-name-cell {
        font-weight: 600;
        color: var(--text-primary);
        white-space: nowrap;
    }

    .db-info-cell {
        font-family: 'Courier New', monospace;
        color: var(--text-secondary);
        white-space: nowrap;
    }

    .field-type-badge {
        display: inline-block;
        padding: 4px 10px;
        background: var(--bg-color);
        border-radius: 6px;
        font-size: 11px;
        color: var(--text-secondary);
        white-space: nowrap;
    }

    .type-cell {
        white-space: nowrap;
    }

    .prompt-cell {
        width: 400px;
    }

    .actions-cell {
        white-space: nowrap;
    }

    .prompt-textarea {
        width: 100%;
        min-height: 80px;
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 13px;
        font-family: inherit;
        line-height: 1.5;
        resize: vertical;
        transition: all 0.2s;
    }

    .prompt-textarea:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(49, 130, 246, 0.1);
    }

    .prompt-textarea:disabled {
        background: var(--bg-color);
        color: var(--text-tertiary);
        cursor: not-allowed;
    }

    .btn-save {
        padding: 6px 16px;
        background: var(--primary-blue);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 8px;
        width: 100%;
    }

    .btn-save:hover {
        background: var(--primary-blue-hover);
    }

    .btn-save:disabled {
        background: var(--text-tertiary);
        cursor: not-allowed;
    }

    .btn-save-action {
        padding: 6px 12px;
        background: var(--primary-blue);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .btn-save-action:hover {
        background: var(--primary-blue-hover);
        transform: translateY(-1px);
    }

    .actions-cell {
        text-align: center;
        white-space: nowrap;
        min-width: 100px;
    }

    .add-mapping-section {
        background: var(--card-bg);
        border: 2px dashed var(--border-color);
        border-radius: 12px;
        padding: 32px;
    }

    #addMappingSection > h3,
    #addMappingSection > p,
    #addMappingSection > #showFormBtn {
        text-align: center;
    }

    .btn-add-mapping {
        padding: 12px 28px;
        background: white;
        color: var(--primary-blue);
        border: 2px solid var(--primary-blue);
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-add-mapping:hover {
        background: var(--primary-blue);
        color: white;
    }

    .btn-edit,
    .btn-delete {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        background: transparent;
    }

    .btn-edit:hover {
        background: var(--bg-color);
        transform: scale(1.1);
    }

    .btn-delete:hover {
        background: #FEF2F2;
        transform: scale(1.1);
    }

    #mappingForm {
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .lock-icon {
        font-size: 14px;
        color: var(--text-tertiary);
    }

    .toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: var(--text-primary);
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: var(--shadow-lg);
        display: none;
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .toast.show {
        display: block;
    }

    .declaration-info-section {
        margin-bottom: 40px;
    }

    .info-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .info-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
    }

    .info-value {
        font-size: 15px;
        color: var(--text-primary);
        font-weight: 500;
    }

    .info-value code {
        background: var(--bg-color);
        padding: 4px 8px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
    }

    .type-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
    }

    .type-badge.export {
        background: #DBEAFE;
        color: #1E40AF;
    }

    .type-badge.import {
        background: #D1FAE5;
        color: #065F46;
    }

    .type-badge.correction {
        background: #FEF3C7;
        color: #92400E;
    }

    .metadata-textarea {
        width: 100%;
        min-height: 200px;
        padding: 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
        line-height: 1.6;
        resize: vertical;
        transition: all 0.2s;
        background: var(--card-bg);
    }

    .metadata-textarea:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 4px rgba(49, 130, 246, 0.1);
    }

    .metadata-textarea::placeholder {
        color: var(--text-tertiary);
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<div class="breadcrumb">
    {% if user.user_type == 'admin' %}
    <a href="{% url 'service_list' %}">ì„œë¹„ìŠ¤ ë¦¬ìŠ¤íŠ¸</a>
    <span>â€º</span>
    <a href="{% url 'service_detail' service_user.service.slug %}">{{ service_user.service.name }}</a>
    {% else %}
    <a href="{% url 'dashboard' %}">ëŒ€ì‹œë³´ë“œ</a>
    {% endif %}
    <span>â€º</span>
    <a href="{% url 'declaration_list_with_user' service_user.service.slug service_user.user.customs_code|default:'default' %}">ì‹ ê³ ì„œ ê´€ë¦¬</a>
    <span>â€º</span>
    <span>{{ declaration.name }}</span>
</div>

<div class="page-header">
    <div>
        <h1>{{ declaration.name }}</h1>
        <p style="color: var(--text-secondary); font-size: 16px;">
            ì‹ ê³ ì„œ ì •ì˜ ë° ë§¤í•‘ì •ë³´ ì„¤ì •
        </p>
    </div>
</div>

<!-- ì‹ ê³ ì„œ ì •ì˜ ì„¹ì…˜ (ê¸°ë³¸ ì„¤ì •ì—ì„œë§Œ í‘œì‹œ) -->
{% if service_user.is_default %}
<div class="declaration-info-section">
    <div class="section-title">
        <div class="section-icon">ğŸ“‹</div>
        <span>ì‹ ê³ ì„œ ì •ì˜</span>
    </div>

    <div class="info-card">
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">ì‹ ê³ ì„œëª…</div>
                <div class="info-value">{{ declaration.name }}</div>
            </div>

            <div class="info-item">
                <div class="info-label">ì‹ ê³ ì„œ ì½”ë“œ</div>
                <div class="info-value"><code>{{ declaration.code }}</code></div>
            </div>

            <div class="info-item">
                <div class="info-label">ì‹ ê³ ì„œ ìœ í˜•</div>
                <div class="info-value">
                    {% if declaration.declaration_type %}
                        <span class="type-badge {{ declaration.declaration_type }}">
                            {{ declaration.get_declaration_type_display }}
                        </span>
                    {% else %}
                        <span style="color: var(--text-tertiary);">ë¯¸ì§€ì •</span>
                    {% endif %}
                </div>
            </div>

            <div class="info-item">
                <div class="info-label">ì„œë¹„ìŠ¤</div>
                <div class="info-value">{{ declaration.service.name }}</div>
            </div>

            {% if declaration.description %}
            <div class="info-item" style="grid-column: 1 / -1;">
                <div class="info-label">ì„¤ëª…</div>
                <div class="info-value">{{ declaration.description }}</div>
            </div>
            {% endif %}

            <div class="info-item" style="grid-column: 1 / -1; margin-top: 20px;">
                <div class="info-label" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span>ğŸ¤– AI ë©”íƒ€ë°ì´í„° (ìƒì„±í˜• AIì— ì „ë‹¬í•  ì»¨í…ìŠ¤íŠ¸ ì •ë³´)</span>
                    <button class="btn-save" onclick="saveMetadata()" style="width: auto; margin-top: 0; padding: 8px 20px;">
                        ì €ì¥
                    </button>
                </div>
                <textarea
                    id="metadataInput"
                    class="metadata-textarea"
                    placeholder="ì˜ˆ: ì´ ì‹ ê³ ì„œëŠ” ìˆ˜ì¶œì‹ ê³ ì„œì…ë‹ˆë‹¤. ì‹ ê³ ì¸ ì •ë³´, ë¬¼í’ˆì •ë³´, ê±°ë˜ì¡°ê±´ ë“±ì´ í¬í•¨ë©ë‹ˆë‹¤. íŠ¹ë³„íˆ ì£¼ì˜í•´ì•¼ í•  ì‚¬í•­..."
                >{{ declaration.description|default:"" }}</textarea>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="mapping-section">
    <div class="section-title">
        <div class="section-icon">âš™ï¸</div>
        <span>ë§¤í•‘ ì •ë³´ ë° í”„ë¡¬í”„íŠ¸</span>
    </div>

    {% if mapping_data %}
    <div class="mapping-table-container">
        <table class="mapping-table">
            <thead>
                <tr>
                    <th>ìœ ë‹ˆíŒ¨ìŠ¤ í•­ëª©ëª…</th>
                    <th>DB í…Œì´ë¸”.í•„ë“œ</th>
                    <th>íƒ€ì…</th>
                    {% if service_user.is_default and user.user_type == 'admin' %}
                    <th>ğŸ“ ê¸°ë³¸ ì…ë ¥í•­ëª©</th>
                    {% endif %}
                    <th>â• ì¶”ê°€ ì…ë ¥í•­ëª©</th>
                    <th style="text-align: center;">ì‘ì—…</th>
                </tr>
            </thead>
            <tbody>
                {% for item in mapping_data %}
                <tr id="mapping-{{ item.mapping.id }}">
                    <td class="field-name-cell">{{ item.mapping.unipass_field_name }}</td>
                    <td class="db-info-cell">{{ item.mapping.db_table_name }}.{{ item.mapping.db_field_name }}</td>
                    <td class="type-cell">
                        <span class="field-type-badge">
                            {{ item.mapping.get_field_type_display }}
                            {% if item.mapping.field_length %}({{ item.mapping.field_length }}){% endif %}
                        </span>
                    </td>

                    <!-- ê¸°ë³¸ ì…ë ¥í•­ëª© (ê¸°ë³¸ í”„ë¡œí•„ì´ê³  ê´€ë¦¬ìì¸ ê²½ìš°ë§Œ í‘œì‹œ) -->
                    {% if service_user.is_default and user.user_type == 'admin' %}
                    <td class="prompt-cell">
                        <textarea
                            class="prompt-textarea"
                            id="basic-prompt-{{ item.mapping.id }}"
                            placeholder="ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ì…ë ¥..."
                        >{{ item.basic_prompt.prompt_text|default:"" }}</textarea>
                    </td>
                    {% endif %}

                    <!-- ì¶”ê°€ ì…ë ¥í•­ëª© -->
                    <td class="prompt-cell">
                        <textarea
                            class="prompt-textarea"
                            id="additional-prompt-{{ item.mapping.id }}"
                            placeholder="ì¶”ê°€ í”„ë¡¬í”„íŠ¸ ì…ë ¥..."
                            {% if not can_edit_additional %}disabled{% endif %}
                        >{{ item.additional_prompt.prompt_text|default:"" }}</textarea>
                        {% if not can_edit_additional %}
                        <div style="margin-top: 8px; font-size: 12px; color: var(--text-tertiary);">ğŸ”’ ê¶Œí•œ ì—†ìŒ</div>
                        {% endif %}
                    </td>

                    <td class="actions-cell">
                        <div style="display: flex; flex-direction: column; gap: 8px; align-items: stretch;">
                            {% if service_user.is_default and user.user_type == 'admin' %}
                            <button class="btn-save-action" onclick="saveAllPrompts({{ item.mapping.id }}, {{ service_user.id }})" title="í”„ë¡¬í”„íŠ¸ ì €ì¥">
                                ğŸ’¾ ì €ì¥
                            </button>
                            {% elif can_edit_additional %}
                            <button class="btn-save-action" onclick="savePrompt({{ item.mapping.id }}, 'additional', {{ service_user.id }})" title="í”„ë¡¬í”„íŠ¸ ì €ì¥">
                                ğŸ’¾ ì €ì¥
                            </button>
                            {% endif %}
                            <div style="display: flex; gap: 4px; justify-content: center;">
                                <button class="btn-edit" onclick="editMapping({{ item.mapping.id }}, '{{ item.mapping.unipass_field_name }}', '{{ item.mapping.db_table_name }}', '{{ item.mapping.db_field_name }}', '{{ item.mapping.field_type }}', {{ item.mapping.field_length|default:'null' }})" title="ë§¤í•‘ ìˆ˜ì •">
                                    âœï¸
                                </button>
                                <button class="btn-delete" onclick="deleteMapping({{ item.mapping.id }})" title="ë§¤í•‘ ì‚­ì œ">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="card">
        <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
            ë“±ë¡ëœ ë§¤í•‘ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.
        </p>
    </div>
    {% endif %}
</div>

<div class="add-mapping-section" id="addMappingSection">
    <h3 style="margin-bottom: 12px;">ìƒˆ ë§¤í•‘ ì¶”ê°€</h3>
    <p style="color: var(--text-secondary); margin-bottom: 24px; font-size: 14px;">
        ìœ ë‹ˆíŒ¨ìŠ¤ í•­ëª©ê³¼ DB í•„ë“œë¥¼ ë§¤í•‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
    </p>
    <button class="btn-add-mapping" id="showFormBtn" onclick="toggleMappingForm()">
        + ë§¤í•‘ ì¶”ê°€í•˜ê¸°
    </button>

    <!-- ë§¤í•‘ ì¶”ê°€/ìˆ˜ì • í¼ (ìˆ¨ê²¨ì§„ ìƒíƒœ) -->
    <div id="mappingForm" style="display: none; margin-top: 24px;">
        <div style="background: white; padding: 24px; border-radius: 12px; border: 2px solid var(--primary-blue);">
            <input type="hidden" id="mappingId" value="" />

            <div class="form-group">
                <label class="form-label">ìœ ë‹ˆíŒ¨ìŠ¤ í•­ëª©ëª… *</label>
                <input type="text" id="unipassField" class="form-input" placeholder="ì˜ˆ: ì‹ ê³ ë²ˆí˜¸" />
            </div>

            <div class="form-group">
                <label class="form-label">DB í…Œì´ë¸”ëª… *</label>
                <input type="text" id="dbTable" class="form-input" placeholder="ì˜ˆ: ImportDeclaration" />
            </div>

            <div class="form-group">
                <label class="form-label">DB í•„ë“œëª… *</label>
                <input type="text" id="dbField" class="form-input" placeholder="ì˜ˆ: Rpt_num" />
            </div>

            <div class="form-group">
                <label class="form-label">í•„ë“œ íƒ€ì… *</label>
                <select id="fieldType" class="form-input">
                    <option value="string">ë¬¸ìì—´</option>
                    <option value="number">ìˆ«ì</option>
                    <option value="date">ë‚ ì§œ</option>
                    <option value="datetime">ë‚ ì§œì‹œê°„</option>
                    <option value="boolean">ì°¸/ê±°ì§“</option>
                </select>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">í•„ë“œ ê¸¸ì´ (ì„ íƒ)</label>
                <input type="number" id="fieldLength" class="form-input" placeholder="ì˜ˆ: 100" min="1" />
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-secondary" onclick="toggleMappingForm()" style="flex: 1;">
                    ì·¨ì†Œ
                </button>
                <button class="btn btn-primary" onclick="submitMapping()" style="flex: 1;" id="submitBtn">
                    ì¶”ê°€
                </button>
            </div>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

function savePrompt(mappingId, promptType, serviceUserId) {
    const textarea = document.getElementById(`${promptType}-prompt-${mappingId}`);
    const promptText = textarea.value;

    fetch(`/api/prompt/${mappingId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: new URLSearchParams({
            'prompt_type': promptType,
            'prompt_text': promptText,
            'service_user_id': serviceUserId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        } else {
            showToast('ì˜¤ë¥˜: ' + data.error);
        }
    })
    .catch(error => {
        showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        console.error('Error:', error);
    });
}

function toggleMappingForm() {
    const form = document.getElementById('mappingForm');
    const btn = document.getElementById('showFormBtn');
    const submitBtn = document.getElementById('submitBtn');

    if (form.style.display === 'none') {
        form.style.display = 'block';
        btn.style.display = 'none';
        // ì…ë ¥ê°’ ì´ˆê¸°í™”
        document.getElementById('mappingId').value = '';
        document.getElementById('unipassField').value = '';
        document.getElementById('dbTable').value = '';
        document.getElementById('dbField').value = '';
        document.getElementById('fieldType').value = 'string';
        document.getElementById('fieldLength').value = '';
        // ë²„íŠ¼ í…ìŠ¤íŠ¸ë¥¼ "ì¶”ê°€"ë¡œ ë³€ê²½
        submitBtn.textContent = 'ì¶”ê°€';
        submitBtn.onclick = submitMapping;
        // ì²« ë²ˆì§¸ ì…ë ¥ë€ì— í¬ì»¤ìŠ¤
        document.getElementById('unipassField').focus();
    } else {
        form.style.display = 'none';
        btn.style.display = 'block';
        // ì…ë ¥ê°’ ì´ˆê¸°í™”
        document.getElementById('mappingId').value = '';
        document.getElementById('unipassField').value = '';
        document.getElementById('dbTable').value = '';
        document.getElementById('dbField').value = '';
        document.getElementById('fieldType').value = 'string';
        document.getElementById('fieldLength').value = '';
    }
}

function submitMapping() {
    const unipassField = document.getElementById('unipassField').value.trim();
    const dbTable = document.getElementById('dbTable').value.trim();
    const dbField = document.getElementById('dbField').value.trim();

    // ìœ íš¨ì„± ê²€ì‚¬
    if (!unipassField) {
        showToast('ìœ ë‹ˆíŒ¨ìŠ¤ í•­ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”');
        document.getElementById('unipassField').focus();
        return;
    }
    if (!dbTable) {
        showToast('DB í…Œì´ë¸”ëª…ì„ ì…ë ¥í•˜ì„¸ìš”');
        document.getElementById('dbTable').focus();
        return;
    }
    if (!dbField) {
        showToast('DB í•„ë“œëª…ì„ ì…ë ¥í•˜ì„¸ìš”');
        document.getElementById('dbField').focus();
        return;
    }

    fetch(`/api/mapping/{{ declaration.id }}/add/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: new URLSearchParams({
            'unipass_field_name': unipassField,
            'db_table_name': dbTable,
            'db_field_name': dbField,
            'service_user_id': {{ service_user.id }}
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('ë§¤í•‘ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showToast('ì˜¤ë¥˜: ' + data.error);
        }
    })
    .catch(error => {
        showToast('ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        console.error('Error:', error);
    });
}

function editMapping(mappingId, unipassField, dbTable, dbField, fieldType, fieldLength) {
    // í¼ í‘œì‹œ
    const form = document.getElementById('mappingForm');
    const btn = document.getElementById('showFormBtn');
    const submitBtn = document.getElementById('submitBtn');

    form.style.display = 'block';
    btn.style.display = 'none';

    // í¼ì— ê¸°ì¡´ ê°’ ì±„ìš°ê¸°
    document.getElementById('mappingId').value = mappingId;
    document.getElementById('unipassField').value = unipassField;
    document.getElementById('dbTable').value = dbTable;
    document.getElementById('dbField').value = dbField;
    document.getElementById('fieldType').value = fieldType;
    document.getElementById('fieldLength').value = fieldLength || '';

    // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
    submitBtn.textContent = 'ìˆ˜ì •';
    submitBtn.onclick = function() { updateMapping(mappingId); };

    // í¼ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    form.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function updateMapping(mappingId) {
    const unipassField = document.getElementById('unipassField').value.trim();
    const dbTable = document.getElementById('dbTable').value.trim();
    const dbField = document.getElementById('dbField').value.trim();
    const fieldType = document.getElementById('fieldType').value;
    const fieldLength = document.getElementById('fieldLength').value;

    // ìœ íš¨ì„± ê²€ì‚¬
    if (!unipassField || !dbTable || !dbField) {
        showToast('í•„ìˆ˜ í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
    }

    fetch(`/api/mapping/${mappingId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: new URLSearchParams({
            'unipass_field_name': unipassField,
            'db_table_name': dbTable,
            'db_field_name': dbField,
            'field_type': fieldType,
            'field_length': fieldLength
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('ë§¤í•‘ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showToast('ì˜¤ë¥˜: ' + data.error);
        }
    })
    .catch(error => {
        showToast('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        console.error('Error:', error);
    });
}

function deleteMapping(mappingId) {
    if (!confirm('ì´ ë§¤í•‘ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì—°ê´€ëœ í”„ë¡¬í”„íŠ¸ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) {
        return;
    }

    fetch(`/api/mapping/${mappingId}/delete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('ë§¤í•‘ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showToast('ì˜¤ë¥˜: ' + data.error);
        }
    })
    .catch(error => {
        showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        console.error('Error:', error);
    });
}

function saveMetadata() {
    const metadata = document.getElementById('metadataInput').value.trim();

    fetch(`/api/declaration/{{ declaration.id }}/metadata/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: new URLSearchParams({
            'metadata': metadata
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('ë©”íƒ€ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        } else {
            showToast('ì˜¤ë¥˜: ' + data.error);
        }
    })
    .catch(error => {
        showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        console.error('Error:', error);
    });
}

function saveAllPrompts(mappingId, serviceUserId) {
    // ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ì™€ ì¶”ê°€ í”„ë¡¬í”„íŠ¸ë¥¼ ëª¨ë‘ ì €ì¥
    const basicTextarea = document.getElementById(`basic-prompt-${mappingId}`);
    const additionalTextarea = document.getElementById(`additional-prompt-${mappingId}`);

    let saveCount = 0;
    let totalSaves = 0;

    if (basicTextarea) totalSaves++;
    if (additionalTextarea) totalSaves++;

    const checkCompletion = () => {
        saveCount++;
        if (saveCount === totalSaves) {
            showToast('í”„ë¡¬í”„íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        }
    };

    // ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ì €ì¥
    if (basicTextarea) {
        const basicText = basicTextarea.value;
        fetch(`/api/prompt/${mappingId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: new URLSearchParams({
                'prompt_type': 'basic',
                'prompt_text': basicText,
                'service_user_id': serviceUserId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                checkCompletion();
            } else {
                showToast('ì˜¤ë¥˜: ' + data.error);
            }
        })
        .catch(error => {
            showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            console.error('Error:', error);
        });
    }

    // ì¶”ê°€ í”„ë¡¬í”„íŠ¸ ì €ì¥
    if (additionalTextarea) {
        const additionalText = additionalTextarea.value;
        fetch(`/api/prompt/${mappingId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: new URLSearchParams({
                'prompt_type': 'additional',
                'prompt_text': additionalText,
                'service_user_id': serviceUserId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                checkCompletion();
            } else {
                showToast('ì˜¤ë¥˜: ' + data.error);
            }
        })
        .catch(error => {
            showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            console.error('Error:', error);
        });
    }
}
</script>
{% endblock %}
